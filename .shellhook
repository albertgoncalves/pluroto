#!/usr/bin/env bash

export WD=$PWD

for x in bin out; do
    if [ ! -d "$WD/$x" ]; then
        mkdir "$WD/$x"
    fi
done

export flags=(
    "-ferror-limit=1"
    "-fno-exceptions"
    "-fno-math-errno"
    "-fno-omit-frame-pointer"
    "-fno-rtti"
    "-fno-unwind-tables"
    "-fsanitize=address"
    "-fsanitize=undefined"
    "-fshort-enums"
    "-march=native"
    "-O1"
    "-std=c++11"
    "-Werror"
    "-Weverything"
    "-Wno-c++98-compat"
    "-Wno-c++98-compat-pedantic"
    "-Wno-c99-extensions"
    "-Wno-covered-switch-default"
    "-Wno-extra-semi-stmt"
    "-Wno-padded"
)

runc () {
    handle=$(echo "$1" | sed 's/^[a-z\/]*\/\(.*\)\.[a-z]*$/\1/')
    clang-format -i -verbose "$1" || return
    mold -run clang++ "${flags[@]}" -o "$WD/bin/${handle}" "$1" || return
    if [ -z "$2" ]; then
        "$WD/bin/${handle}"
    else
        "$WD/bin/${handle}" "$2"
    fi
}

export -f runc
